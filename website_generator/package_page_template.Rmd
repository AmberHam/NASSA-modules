---
editor_options: 
  chunk_output_type: console
link-citations: false
output:
  html_document:
    css: styles.css #website_source/styles.css
bibliography: "`r cur_bib <- paste0('####module_name####', '.bib'); if (file.exists(cur_bib)) { cur_bib } else { 'dummy.bib' }`"
nocite: '@*' #add all items to the bibliography
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```

```{r dependencies}
library(magrittr)
library(visNetwork)
library(fontawesome)
library(htmltools)
```

```{r ymlfile}
module_name <- "####module_name####" #"2022-Romanowska-002"
module_path <- file.path("../..", module_name) #file.path("..", module_name)
nassa_yml_file <- list.files(module_path, pattern = "NASSA.yml", full.names = TRUE)
nassa_yml <- yaml::read_yaml(nassa_yml_file)
```

# `r nassa_yml$title`

`r nassa_yml$id`, (Last updated: `r nassa_yml$lastUpdateDate`) 

***

<div class="row">
<div class="column">

#### Authors

```{r authors, results='asis'}
authors <- purrr::map_chr(
  nassa_yml$contributors, \(x) {
    author = x$name
    roles = paste(x$roles, collapse = ", ")
    email = x$email
    orcid = x$orcid
    paste(
      strong(author),
      paste0(
        htmltools::tags$a(
          fontawesome::fa("envelope", fill = "#03989E"),
          target = "_blank",
          href = paste0("mailto:", email)
        ),
        htmltools::tags$a(
          fontawesome::fa("orcid", fill = "#03989E"),
          target = "_blank",
          href = paste0("https://orcid.org/", orcid)
        )
      ),
      paste0("(", roles, ")")
    )
  }
)

cat(paste(authors, collapse = "<br>"))
```

#### Code

```{r}
github_link <- htmltools::tags$a(
  fontawesome::fa("github", fill = "#03989E"),
  target = "_blank",
  href = paste0("https://github.com/Archaeology-ABM/NASSA-modules/tree/main/", module_name)
)
languages <- purrr::map(nassa_yml$implementations, function(y) {
  htmltools::tags$span(class = "badge", y$language)
})
```

See this module's code on GitHub: `r github_link`

Languages: `r languages`

</div>
<div class="column">

#### Tags

```{r tags}
ba <- function(x) {
  purrr::map(x, function(y) {
    htmltools::tags$span(class = "badge", y)
  })
}
```

<table>
<tr><td>Class:</td><td>`r ba(nassa_yml$moduleType)`</td></tr>
<tr><td>Regions:</td><td>`r ba(nassa_yml$domainKeywords$regions)`</td></tr>
<tr><td>Periods:</td><td>`r ba(nassa_yml$domainKeywords$periods)`</td></tr>
<tr><td>Subjects:</td><td>`r ba(nassa_yml$domainKeywords$subjects)`</td></tr>
<tr><td>Model:</td><td>`r ba(nassa_yml$modellingKeywords)`</td></tr>
<tr><td>Programming:</td><td>`r ba(nassa_yml$programmingKeywords)`</td></tr>
</table> 

</div>
</div>

***

#### Input and output

```{r in_and_out, results='asis'}
if (!is.null(nassa_yml$inputs) & !is.null(nassa_yml$outputs)) {
  
  inputs <- purrr::map_dfr(nassa_yml$inputs, \(x) { tibble::as_tibble(x) }) %>%
    dplyr::transmute(
      id = seq_len(dplyr::n()) + 1,
      label = name,
      group = "input",
      title = paste0(
        "<b>Data type:</b> ", type, "<br>",
        "<b>Description:</b> ", description
      )
    )
  outputs <- purrr::map_dfr(nassa_yml$outputs, \(x) { tibble::as_tibble(x) }) %>%
      dplyr::transmute(
      id = seq_len(dplyr::n()) + max(inputs$id),
      label = name,
      group = "output",
      title = paste0(
        "<b>Data type:</b> ", type, "<br>",
        "<b>Description:</b> ", description
      )
    )
  
  nodes <- dplyr::bind_rows(inputs, outputs, tibble::tibble(id = 1, group = "module"))
  edges <- dplyr::bind_rows(
    toCenter   = data.frame(from = inputs$id, to = 1),
    fromCenter = data.frame(from = 1, to = outputs$id)
  )
  
  numberOfElementsMax = 24 # an arbitrary ceiling value for adjusting label size of nodes
  numberOfElements = min(c(length(inputs) + length(outputs), numberOfElementsMax)) 
  
  labelSizeMin = 10
  labelSizeMax = 48
  labelSizeAdj = labelSizeMin + (labelSizeMax - labelSizeMin) * (1 - numberOfElements / numberOfElementsMax) ^ 0.6
  
  initZoomMin = 0.3
  initZoomMax = 1
  initZoomAdj = initZoomMin + (initZoomMax - initZoomMin) * (1 - numberOfElements / numberOfElementsMax) ^ 3
  
  visNetwork(nodes, edges, width = "100%") %>%
    visGroups(groupname = "input", color = list(border = "black", background = "white")) %>%
    visGroups(
      shape = "diamond",
      groupname = "output", color = list(border = "black", background = "lightgrey")
    ) %>%
    visGroups(
      shape = "hexagon",
      size = 40,
      groupname = "module", color = list(border = "black", background = "#03989E")
    ) %>%
    visNodes(
      font = list(size = labelSizeAdj),
      shadow = TRUE
    ) %>%
    visEdges(
      color = list(color = "darkgrey"),
      arrows = list(to = list(enabled = TRUE, scaleFactor = 1))
    ) %>%
    # set a hierarchical layout
    visHierarchicalLayout(direction = 'LR', sortMethod = 'directed', levelSeparation = 500) %>%
    # initialise zoom in proportion to the number of nodes
    visEvents(startStabilizing = paste0("function() {this.moveTo({scale:", initZoomAdj, "})}"), type = "once") %>% visPhysics(stabilization = FALSE) %>%
    visInteraction(
      tooltipStyle = 
        'position: fixed;visibility:hidden;padding: 5px;
         font-family: verdana;font-size:14px;font-color:#000000;background-color: #f5f4ed;
         -moz-border-radius: 3px;-webkit-border-radius: 3px;border-radius: 3px;
         border: 1px solid #808074;box-shadow: 3px 3px 10px rgba(0, 0, 0, 0.2);
         max-width:300px;word-break: normal'
    )

} else { cat("Module in- and output not provided") }
```

***

#### README

<div class="readme">

```{r readme, results='asis'}
if (!is.null(nassa_yml$readmeFile)) {
  readme_file <- file.path(module_path, nassa_yml$readmeFile)
  readme <- readLines(readme_file)
  ### correct relative paths 
  for (aLineIndex in 1:length(readme))
  {
    if (!grepl("\\]\\(http", readme[aLineIndex])) # or ignore all html links by using "\\.htm"
    {
      # position relative path at the module root as intended in README.md
      readme[aLineIndex] <- gsub("\\]\\(", paste0("](../../../", nassa_yml$id, "/"), readme[aLineIndex])
    }
  }
  #readme <- gsub("\\]\\(", paste0("](../../../", nassa_yml$id, "/"), readme) # TO-DO: find passing regular expression that selects fragment while excluding html links
  cat(readme, sep = "\n\n")
}
```

</div>

***

#### References

<div id="refs"></div>
